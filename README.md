# 0. Env
```shell
$ conda env create -n vkr -c bioconda treecluster ncbi-datasets-cli
$ conda activate vkr
```

# 1. Clustering
```shell
$ ./scripts/cluster_genomes.jl -i DATA/GTDB -o DATA/clusters
```


## Top 100 annotated:
```shell
$ awk -F"\t" '                                      
NR==1 {
  for(i=1;i<=NF;i++) {
    if($i=="gtdb_taxonomy") { tax_idx=i; break }
  }
  next
}
{
  if($tax_idx ~ /;s__[^;]+$/ || $tax_idx ~ /^s__[^;]+$/) {
    count[$tax_idx]++
  }
}
END {
  for(t in count)
    printf("%d\t%s\n", count[t], t)
}' \
DATA/GTDB/bac120_metadata_r220.tsv | \
sort -nr | \
head -n 100 > DATA/GTDB/top100_repeated_species.tsv
```

# 2. Downloading genomes
```shell
$ julia -t 10 scripts/download_genomes.jl -i DATA/cluseter/cg_hq.tsv -o DATA/genomes/ -e -p 10
```

Calculating chromosomes:
```
find DATA/genomes/genomes -mindepth 1 -maxdepth 1 -type d | xargs -I{} -P 10 bash -c '
    dir="{}"                     
    file="$dir/$(basename "$dir").fna"
    count=$(grep -c ">" "$file")
    touch "$dir/n_chroms=$count"
'
```

# X. Experiment results:
## CDS starts
* train 1000 pseudmnt
* test 100 pseudmnt

### `2025-04-08` window=61
```

epochs=12
pad=30
window=61
gamma=3
lr=[0.005 x 3, 0.002 x 3, 0.0008 x 3, 0.00032 x 3]
loss=[0.00037685703, 0.00022302769, 0.00020763752, 0.00019436877, 0.00018928376, 0.00018650031, 0.00018145659, 0.00017990194, 0.00017909888, 0.00017715435, 0.00017665839, 0.00017631172]
CM:
┌────────┬───────────┬────────┬───────────┐
│ tr\pred│   Cl 1    │  Cl 2  │     Total │
├────────┼───────────┼────────┼───────────┤
│ Class1 │ 509146819 │  56100 │ 509202919 │
│ Class2 │    110345 │ 120642 │    230987 │
│  Total │ 509257164 │ 176742 │ 509433906 │
└────────┴───────────┴────────┴───────────┘
Class 1:
Prescision = 0.683
Recall     = 0.522
F1         = 0.592
FDR        = 0.317
Specificity= 1.0
Support    = 230987
```

### `2025-04-09T22:15:58.046` window=51
```
time=14686 seconds
epochs=10
pad=25
window=51
gamma=3
lr=[0.005, 0.003, 0.0018, 0.00108, 0.000648, 0.0003888, 0.00023328, 0.000139968, 8.39808e-5, 5.038848e-5]
decay=0.6
loss=[0.001215547, 0.000233086, 0.00021530787, 0.0002071661, 0.0002007706, 0.00019636184, 0.00019344417, 0.00019183647, 0.0001908592, 0.00019024262]
CM:
┌────────┬───────────┬────────┐
│ tr\pred│   Cl 1    │  Cl 2  │
├────────┼───────────┼────────┤
│ Class1 │ 509156069 │  46850 │
│ Class2 │    124657 │ 106330 │
└────────┴───────────┴────────┘
Class 1:
Prescision = 0.694151
Recall     = 0.460329
F1         = 0.553561
FDR        = 0.305849
Specificity= 0.999908
Support    = 230987
```

### `2025-04-09T22:20:01.208` window=71
```
time=15231 seconds
epochs=10
pad=35
window=71
gamma=3
lr=[0.005, 0.003, 0.0018, 0.00108, 0.000648, 0.0003888, 0.00023328, 0.000139968, 8.39808e-5, 5.038848e-5]
decay=0.6
loss=[0.00049170887, 0.00021514256, 0.00019736601, 0.00018857144, 0.00018282037, 0.00017939335, 0.00017721848, 0.00017586554, 0.00017515, 0.00017457388]
CM:
┌────────┬───────────┬────────┐
│ tr\pred│   Cl 1    │  Cl 2  │
├────────┼───────────┼────────┤
│ Class1 │ 509164058 │  38861 │
│ Class2 │    119174 │ 111813 │
└────────┴───────────┴────────┘
Class 1:
Prescision = 0.742086
Recall     = 0.484066
F1         = 0.585928
FDR        = 0.257914
Specificity= 0.999924
Support    = 230987
```

### `2025-04-10T08:45:28.837` window=101
```
time (last 4) = 8614 seconds
epochs=11
pad=50
window=101
gamma=3
lr=[0.005, 0.003, 0.0018, 0.00108, 0.000648, 0.0003888, 0.00023328, 0.000139968, 8.39808e-5, 5.038848e-5, 3.0233088e-5]
decay=0.6
loss=[0.0004275781, 0.00020601676, 0.00018632758, 0.00017531123, 0.0001691626, 0.00016512007, 0.00016103935, 0.00016013924, 0.00015960356, 0.00015926246]
CM:
┌────────┬───────────┬────────┐
│ tr\pred│   Cl 1    │  Cl 2  │
├────────┼───────────┼────────┤
│ Class1 │ 509173086 │  29833 │
│ Class2 │    115489 │ 115498 │
└────────┴───────────┴────────┘
Class 1:
Prescision = 0.7947237685008705
Recall     = 0.5000194816158485
F1         = 0.6138319187495682
FDR        = 0.20527623149912957
Specificity= 0.999941412354708
Support    = 230987
```

### `2025-04-10T08:45:31.485` window=121
```
time (last 4) = 7629 seconds
epochs=11
pad=60
window=121
gamma=3
lr=[0.005, 0.003, 0.0018, 0.00108, 0.000648, 0.0003888, 0.00023328, 0.000139968, 8.39808e-5, 5.038848e-5, 3.0233088e-5]
decay=0.6
loss=[0.0017094455, 0.00020088236, 0.00018075113, 0.00016979828, 0.00016232005, 0.00015736172, 0.00015242767, 0.00015145741, 0.00015079798, 0.00015048623]
CM:
┌────────┬───────────┬────────┐
│ tr\pred│   Cl 1    │  Cl 2  │
├────────┼───────────┼────────┤
│ Class1 │ 509172693 │  30226 │
│ Class2 │    107408 │ 123579 │
└────────┴───────────┴────────┘
Class 1:
Prescision = 0.8034784304801534
Recall     = 0.5350041344318078
F1         = 0.6423158485623403
FDR        = 0.19652156951984656
Specificity= 0.9999406405602321
Support    = 230987
```

### `2025-04-10T11:00:55.275` window=141
```
time=18151 seconds
epochs=11
pad=70
window=141
gamma=3
lr=[0.005, 0.003, 0.0018, 0.00108, 0.000648, 0.0003888, 0.00023328, 0.000139968, 8.39808e-5, 5.038848e-5, 3.0233088e-5]
decay=0.6
loss=[?, 0.00019620056, 0.0001678867, 0.00015687295, 0.00015105408, 0.00014784139, 0.00014582755, 0.00014480246, 0.00014415308, 0.00014365354, 0.00014347899]
CM:
┌────────┬───────────┬────────┐
│ tr\pred│   Cl 1    │  Cl 2  │
├────────┼───────────┼────────┤
│ Class1 │ 509174195 │  28724 │
│ Class2 │    103589 │ 127398 │
└────────┴───────────┴────────┘
Class 1:
Prescision = 0.816015680045093
Recall     = 0.5515375324152442
F1         = 0.6582022117801446
FDR        = 0.18398431995490705
Specificity= 0.9999435902683818
Support    = 230987
```

### `2025-04-10T17:08:28.975new_decay` window=141
```
time=14640 seconds
epochs=8
pad=70
window=141
gamma=3
lr=[0.004, 0.003, 0.00225, 0.0016875, 0.001265625, 0.00094921875, 0.0007119140625, 0.000533935546875]
decay=0.75
loss=[0.000443863, 0.00018802582, 0.00017055272, 0.00016093689, 0.0001535322, 0.00014897245, 0.00014537183, 0.00014315695]
CM:
┌────────┬───────────┬────────┐
│ tr\pred│   Cl 1    │  Cl 2  │
├────────┼───────────┼────────┤
│ Class1 │ 509167980 │  34939 │
│ Class2 │     97368 │ 133619 │
└────────┴───────────┴────────┘
Class 1:
Prescision = 0.7927182334863964
Recall     = 0.578469784013819
F1         = 0.6688558234992303
FDR        = 0.20728176651360364
Specificity= 0.9999313849180821
Support    = 230987
```

### `2025-04-10T17:17:09.904new_decay_gamma_4` window=141
```
time=17654 seconds
epochs=8
pad=70
window=141
gamma=4
lr=[0.004, 0.003, 0.00225, 0.0016875, 0.001265625, 0.00094921875, 0.0007119140625, 0.000533935546875]
decay=0.75
loss=[0.0003613095, 0.00010874293, 9.709392f-5, 9.2688235f-5, 8.763613f-5, 8.4336934f-5, 8.223708f-5, 8.076065f-5]
CM:
┌────────┬───────────┬────────┐
│ tr\pred│   Cl 1    │  Cl 2  │
├────────┼───────────┼────────┤
│ Class1 │ 509168708 │  34211 │
│ Class2 │    101007 │ 129980 │
└────────┴───────────┴────────┘
Class 1:
Prescision = 0.7916390057920348
Recall     = 0.562715650664323
F1         = 0.6578301423662247
FDR        = 0.2083609942079651
Specificity= 0.9999328146035235
Support    = 230987
```

### `2025-04-10T22:21:51.072gamma=3.5_smooth_decay_pad=100` window=201
```
time=19570 seconds
epochs=10
pad=100
window=201
gamma=3.5
lr=[0.002, 0.0016, 0.00128000000, 0.00102400000, 0.00081920000, 0.00065536000, 0.00052428800, 0.00041943040, 0.00033554432, 0.000268435456]
decay=0.8
loss=[0.00065066, 0.00013396888, 0.00012173195, 0.00011356909, 0.00010803655, 0.00010340836, 0.000100383484, 9.8348064f-5, 9.683452f-5, 9.5680174f-5]
CM:
┌────────┬───────────┬────────┐
│ tr\pred│   Cl 1    │  Cl 2  │
├────────┼───────────┼────────┤
│ Class1 │ 509170671 │  32248 │
│ Class2 │     90013 │ 140974 │
└────────┴───────────┴────────┘
Class 1:
Prescision = 0.8138342704737274
Recall     = 0.6103114028062185
F1         = 0.6975302380699094
FDR        = 0.18616572952627264
Specificity= 0.9999366696481958
Support    = 230987
```

### `2025-04-11T08:13:55.705gamma=3.5_smooth_decay_pad=125` window=251
```
time=21098 seconds
epochs=10
pad=125
window=251
gamma=3.5
lr=[0.002, 0.0016, 0.00128000000, 0.00102400000, 0.00081920000, 0.00065536000, 0.00052428800, 0.00041943040, 0.00033554432, 0.000268435456]
decay=0.8
loss=[0.0022646503, 0.00013379632, 0.00012161402, 0.00011224154, 0.00010577176, 0.000100446116, 9.6809505f-5, 9.435055f-5, 9.259874f-5, 9.1308044f-5]
CM:
┌────────┬───────────┬────────┐
│ tr\pred│   Cl 1    │  Cl 2  │
├────────┼───────────┼────────┤
│ Class1 │ 509174565 │  28354 │
│ Class2 │     88377 │ 142610 │
└────────┴───────────┴────────┘
Class 1:
Prescision = 0.8341522191806462
Recall     = 0.6173940524791438
F1         = 0.7095889797512632
FDR        = 0.16584778081935378
Specificity= 0.9999443168942242
Support    = 230987
```

### `2025-04-10T21:51:46.666bigger_conv_100` window=201
```julia
Chain(
    Conv((window_size,), input_channels => 256, pad=0, bias=false),
    BatchNorm(256, relu),
    Dropout(0.1),
    
    Conv((3,), 256 => 128, pad=1, bias=false),
    BatchNorm(128, relu),
    Dropout(0.1),
    
    Conv((3,), 128 => 64, pad=1, bias=false),
    BatchNorm(64, relu),

    Conv((3,), 64 => 64, pad=1, bias=false),
    BatchNorm(64, relu),
  
    Conv((1,), 64 => 1),
    x->dropdims(x, dims=(2,3)),
    sigmoid
)
```

```
time=71438 seconds
epochs=10
pad=100
window=201
gamma=3.5
lr=[0.002, 0.0016, 0.00128000000, 0.00102400000, 0.00081920000, 0.00065536000, 0.00052428800, 0.00041943040, 0.00033554432, 0.000268435456]
decay=0.8
loss=[0.0013619821, 0.00013025015, 0.00011712125, 0.00010999785, 0.0001035342, 9.772836f-5, 9.4020426f-5, 9.1496484f-5, 8.956313f-5, 8.8213485f-5]
CM:
┌────────┬───────────┬────────┐
│ tr\pred│   Cl 1    │  Cl 2  │
├────────┼───────────┼────────┤
│ Class1 │ 509181144 │  21775 │
│ Class2 │     94674 │ 136313 │
└────────┴───────────┴────────┘
Class 1:
Prescision = 0.8622602601082942
Recall     = 0.5901327780351275
F1         = 0.7007029493028336
FDR        = 0.13773973989170588
Specificity= 0.9999572370872446
Support    = 230987
```